!function(){"use strict";angular.module("crisis",[])}(),function(){"use strict";var e=angular.module("crisis");e.service("AnnotationLayers",["Renderers",function(e){this.createLayer=function(r){return new tiles.AnnotationLayer({source:r,name:r.name,renderer:e.getPointAggregateRenderer()})}}])}(),function(){"use strict";var e=angular.module("crisis");e.service("BaseLayers",function(){function e(){return{"dark-google":{type:"Google",options:{styles:[{featureType:"all",stylers:[{invert_lightness:!0},{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape.natural.landcover",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{visibility:"on"}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{lightness:"-100"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"administrative.country",elementType:"geometry",stylers:[{visibility:"on"},{lightness:-56}]},{elementType:"labels",stylers:[{lightness:-46},{visibility:"on"}]}]}},"light-google":{type:"Google",options:{styles:[{featureType:"all",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape.natural.landcover",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{visibility:"on"},{gamma:3.2}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{lightness:"100"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"administrative.country",elementType:"geometry",stylers:[{visibility:"on"},{lightness:35}]},{elementType:"labels",stylers:[{lightness:25},{visibility:"on"}]}]}},"dark-plot":{type:"blank",options:{color:"rgb(0,0,0)"}},"light-plot":{type:"blank",options:{color:"rgb(255,255,255)"}}}}this.createBaseLayer=function(e){return new tiles.BaseLayer(e)},this.getBaseLayers=function(r,t){t||(t=r,r="resources/baselayers.json"),$.ajax({url:r,type:"GET",dataType:"json",success:function(e){t(e)},error:function(){t(e())}})}})}(),function(){"use strict";var e=angular.module("crisis");e.service("ClientLayers",["Renderers",function(e){this.createWordCloudLayer=function(r){return new tiles.ClientLayer({source:r,name:r.name+" (word cloud)",renderer:e.getWordCloudRenderer()})},this.createTextByFrequencyLayer=function(r){return new tiles.ClientLayer({source:r,name:r.name+" (trends)",renderer:e.getTextByFrequencyRenderer()})}}])}(),function(){"use strict";var e=angular.module("crisis");e.controller("LayersController",["$scope","$timeout","Maps","Views","Axes","BaseLayers","Layers","Regions",function(e,r,t,n,i,a,s,o){function l(t){function n(){return function(t,n,i){t.addEventListener("click",function(){e.asideVisible=!0,e.aside={elem:t,entry:n,tileData:i},r(function(){e.$digest()})})}}var i,a;for(a=0;a<t.length;a++)i=t[a],i.renderer&&i.renderer instanceof tiles.Renderer&&i.renderer.addHook(n())}function c(r){r.isDirty||(r.isDirty=!0,e.layersByDomain.server&&e.layersByDomain.server[0].setEnabled(!0),e.layersByDomain.client&&e.layersByDomain.client[0].setEnabled(!0))}function u(r){var t=$.Deferred(),c=$.Deferred(),u=$.Deferred(),d=$.Deferred(),f=$.Deferred();s.requestLayers(function(e,r){l(e),t.resolve(r)}),i.getAxes(function(e){d.resolve(e)}),a.getBaseLayers(function(e){u.resolve(e)}),n.getViews(function(e){c.resolve(e)}),o.getRegions(function(e){f.resolve(e)}),$.when(c,t,d,u,f).then(function(t,i,a,s,o){e.views=n.createViews(t,i,s,a),e.regions=o,e.setView(e.views[0]),r()})}e.setView=function(r){e.view!==r&&(e.view=r,e.layers=e.view.layers,e.exclusiveLayers=s.sortExclusiveLayers(e.layers),e.layersByDomain=s.sortByDomain(e.layers),e.layersByGroupThenDomain=s.sortByGroupThenDomain(e.layers),n.switchView(e.map,e.view),c(r),e.map.olMap.zoomToMaxExtent())},e.isViewActive=function(r){return r===e.view},e.toggleAside=function(){e.asideVisible=!e.asideVisible},e.toggleSideControls=function(){e.openControls=!e.openControls},e.jumpToRegion=function(r){e.map.panTo(r.lon,r.lat)},e.toggleTheme=function(){"dark"===e.map.getTheme()?(e.map.setTheme("light"),e.map.setBaseLayerIndex(1)):(e.map.setTheme("dark"),e.map.setBaseLayerIndex(0))},e.toggleDescription=function(){e.openDescription=!e.openDescription},e.toggleLayer=function(r){var t,n=e.exclusiveLayers;if(r.exclusive&&!r.isEnabled())for(t=0;t<n.length;t++)n[t].setEnabled(!1);r.setEnabled(!r.isEnabled())},e.changeRampType=function(t){this.layer.setRampType(t.id,function(){r(function(){e.$digest()})})},e.changeValueTransformType=function(e){this.layer.setValueTransformType(e.id)},e.changeCoarseness=function(e){this.layer.setCoarseness(e.id)},e.map=t.createMap("map"),u(function(){e.map.on("zoomend",function(){r(function(){e.$digest()})})})}])}(),function(){"use strict";var e=angular.module("crisis");e.service("Layers",["Pyramids","ClientLayers","ServerLayers","AnnotationLayers",function(e,r,t,n){function i(e,r,t){r.exclusive=void 0!==t.exclusive?t.exclusive:!1,r.group=t.group||"Tile Layers",r.description=t.description||"",r.setEnabled(!1),c.push(r),u[e]=r}var a=this,s=!1,o=!1,l=[],c=[],u={};this.requestLayers=function(e){return s?void e(c):o?void l.push(e):(o=!0,void tiles.LayerService.getLayers(function(a){var d,f,y,m,g=tiles.LayerUtil.parse(a.layers);for(y in g)if(g.hasOwnProperty(y))switch(d=g[y],d.domain){case"server":f=t.createLayer(d),i(y,f,d);break;case"client":f=r.createWordCloudLayer(d),i(y+"-word-cloud",f,d),f=r.createTextByFrequencyLayer(d),i(y+"-trends",f,d);break;case"annotation":f=n.createLayer(d),i(y,f,d)}for(e(c,u),m=0;m<l.length;m++)l[m](c,u);l=[],o=!1,s=!0}))},this.getLayers=function(){return c},this.getLayersById=function(){return u},this.sortExclusiveLayers=function(e){var r,t=[];for(r=0;r<e.length;r++)e[r].exclusive&&t.push(e[r]);return t},this.sortByPyramid=function(r){var t,n,i={};for(n=0;n<r.length;n++)t=e.getHashFromLayer(r[n]),i[t]=i[t]||[],i[t].push(r[n]);return i},this.sortByDomain=function(e){var r,t,n={};for(t=0;t<e.length;t++)r=e[t].domain,n[r]=n[r]||[],n[r].push(e[t]);return n},this.sortByGroup=function(e){var r,t,n={};for(t=0;t<e.length;t++)r=e[t].group,n[r]=n[r]||[],n[r].push(e[t]);return n},this.sortByGroupThenDomain=function(e){var r,t=a.sortByGroup(e);for(r in t)t.hasOwnProperty(r)&&(t[r]=a.sortByDomain(t[r]));return t}}])}(),function(){"use strict";var e=angular.module("crisis");e.service("ServerLayers",function(){this.createLayer=function(e){var r=new tiles.ServerLayer({source:e,id:e.id,name:e.name,renderer:{ramp:"spectral",coarseness:1,rangeMin:0,rangeMax:100},valueTransform:{type:"log10"}});return r.ramps=[{id:"spectral",name:"Spectral"},{id:"hot",name:"Hot"},{id:"polar",name:"Polar"},{id:"neutral",name:"Neutral"},{id:"cool",name:"Cool"},{id:"valence",name:"Valence"},{id:"flat",name:"Flat"}],r.transforms=[{id:"linear",name:"Linear"},{id:"log10",name:"Log 10"}],r.resolutions=[{id:1,name:"1x1"},{id:2,name:"2x2"},{id:3,name:"4x4"},{id:4,name:"8x8"}],r}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Axes",function(){function e(){return{longitude:{title:"Longitude",enabled:!1,repeat:!0,intervals:{type:"fixed",increment:120,pivot:0},units:{type:"degrees"}},latitude:{title:"Latitude",enabled:!1,repeat:!1,intervals:{type:"fixed",increment:60,pivot:0},units:{type:"degrees"}},x:{title:"X",enabled:!0,intervals:{increment:20,pivot:0},units:{type:"decimal"}},y:{title:"Y",enabled:!0,intervals:{increment:20,pivot:0},units:{type:"decimal"}}}}this.createAxis=function(e,r){return r.position=e,new tiles.Axis(r)},this.getAxes=function(r,t){t||(t=r,r="resources/axes.json"),$.ajax({url:r,type:"GET",dataType:"json",success:function(e){t(e)},error:function(){t(e())}})}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Maps",function(){this.createMap=function(e){return e=e||"map",new tiles.Map(e)}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Pyramids",function(){this.getPyramidFromLayer=function(e){if(e.source.pyramid)return e.source.pyramid;if(e.source.meta){var r=e.source.meta;return{type:"EPSG:4326"===r.projection?"areaofinterest":"webmercator",minX:r.bounds[0],minY:r.bounds[1],maxX:r.bounds[2],maxY:r.bounds[3]}}return{type:"webmercator"}},this.createPyramid=function(e){return e.type&&"areaofinterest"===e.type.toLowerCase()?new tiles.AreaOfInterestTilePyramid(e):new tiles.WebMercatorTilePyramid}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Regions",function(){this.getRegions=function(e,r){r||(r=e,e="resources/regions.json"),$.ajax({url:e,type:"GET",dataType:"json",success:function(e){r(e)},error:function(){r(null)}})}})}(),function(){"use strict";var e=angular.module("crisis");e.directive("dropDownOverlay",["$parse",function(e){return{templateUrl:function(e,r){return r.templateUrl},link:function(r,t,n){function i(){c.css("top","30px"),$(t).addClass("open")}function a(){c.css("top",-c.outerHeight()+"px"),$(t).removeClass("open")}var s=e(n.isOpen),o=s.assign,l=s(r),c=$('<div class="drop-down-overlay-panel"></div>'),u=$(t).children();$(t).addClass("drop-down-overlay-fade"),$(t).click(function(e){e.target===this&&(o(r,!1),r.$digest())}),c=u.wrapAll(c).parent(),l?i():a(),r.$watch(n.isOpen,function(e){e?i():a()})}}}])}(),function(){"use strict";var e=angular.module("crisis"),r=function(e,r){var i=5;return $('<div class="filter-axis"></div>').append(t(i)).append(n(i,e,r))},t=function(e){var r,t=$('<div class="filter-axis-ticks-container"></div>'),n=2*(e-1),i=100/n,a=!0;for(r=0;n>r;r++)t.append(a?'<div class="filter-axis-marker filter-major-marker" style="margin-right:calc('+i+'% - 1px);"></div>':'<div class="filter-axis-marker filter-minor-marker" style="margin-right:calc('+i+'% - 1px);"></div>'),a=!a;return t.append('<div class="filter-axis-marker filter-major-marker" style="margin-left:-1px;"></div>'),t},n=function(e,r,t){var n,i,a=$('<div class="filter-axis-label-container"></div>'),s=100/(e-1),o={stepDown:!0,decimals:1,type:"b"};for(i=0;e>i;i++)n=tiles.Util.denormalizeValue(i/(e-1),r,t),a.append($('<div class="filter-axis-label" style="position:absolute; left:'+s*i+"%; width:"+s+"%; margin-left:-"+s/2+'%;">'+tiles.AxisUtil.formatText(n,o)+"</div>"));return a};e.directive("filterSlider",["SliderLabels",function(e){return{link:function(t,n){var i=0,a=100,s=t.layer;$(n).slider({range:!0,min:i,max:a,values:[s.renderer.rangeMin,s.renderer.rangeMax],change:function(){var e=$(this).slider("option","values");s.setRangeMinPercentage(e[0]/a),s.setRangeMaxPercentage(e[1]/a)},slide:function(r,t){var i=$(t.handle).index()-1,o=t.values,l=tiles.Util.denormalizeValue(o[i]/a,s.getLevelMinMax(),s.getValueTransformType());e.createLabel($($(n)[0].children[1+i]),l)},start:function(r,t){var i=$(t.handle).index()-1,o=t.values,l=tiles.Util.denormalizeValue(o[i]/a,s.getLevelMinMax(),s.getValueTransformType());e.createLabel($($(n)[0].children[1+i]),l)},stop:function(r,t){var i=$(t.handle).index()-1,a=$($(n)[0].children[1+i]);a.is(":hover")||e.removeLabel(a)}}),$(n).find(".ui-slider-handle").each(function(r,t){$(t).mouseover(function(){var t=0===r?s.getRangeMinValue():s.getRangeMaxValue();e.createLabel($(this),t)}),$(t).mouseout(function(){e.removeLabel($(this))})}),$(n).find(".ui-slider-handle").first().addClass("filter-min-handle"),$(n).find(".ui-slider-handle").last().addClass("filter-max-handle"),$(n).append(r(s.getLevelMinMax(),s.getValueTransformType())),t.$watch("layer.rampImageUrl",function(){s.rampImageUrl&&$(n).find(".ui-slider-range").css({background:"url("+s.rampImageUrl+")","background-size":"contain"})}),t.$watch("layer.levelMinMax",function(){s.levelMinMax&&$(n).find(".filter-axis").replaceWith(r(s.getLevelMinMax(),s.getValueTransformType()))})}}}])}(),function(){"use strict";var e=angular.module("crisis");e.directive("opacitySlider",["SliderLabels",function(e){return{link:function(r,t){var n=0,i=100;$(t).slider({range:"min",min:n,max:i,value:r.layer.opacity*i,slide:function(t,n){$(".olTileImage").addClass("no-transition"),$(".olTileHtml").addClass("no-transition"),r.layer.setOpacity(n.value/i),e.createLabel($(this).find(".ui-slider-handle"),n.value/i)},start:function(r,t){e.createLabel($(this).find(".ui-slider-handle"),t.value/i)},stop:function(){var r=$(this).find(".ui-slider-handle");r.is(":hover")||e.removeLabel(r),$(".olTileImage").removeClass("no-transition"),$(".olTileHtml").removeClass("no-transition")}}),$(t).find(".ui-slider-handle").mouseover(function(){e.createLabel($(this),r.layer.getOpacity())}),$(t).find(".ui-slider-handle").mouseout(function(){e.removeLabel($(this))})}}}])}(),function(){"use strict";function e(e){return e[0].scrollWidth}function r(e){return e[0].scrollHeight}function t(){var t,n,a,s,o;for(o=0;o<i.length;o++)t=i[o],s=t.$elem,n=e(s),a=r(s),(t.width!==n||t.height!==a)&&(t.width=n,t.height=a,s.perfectScrollbar("update"))}var n=angular.module("crisis"),i=[],a=500;n.directive("perfectScrollbar",function(){return{link:function(t,n){$(n).css("overflow","hidden"),$(n).perfectScrollbar(),i.push({$elem:$(n),width:e($(n)),height:r($(n))})}}}),setInterval(t,a)}(),function(){"use strict";var e=angular.module("crisis");e.service("SliderLabels",function(){this.createLabel=function(e,r){var t={stepDown:!0,decimals:2,type:"b"},n=$('<div class="slider-value-hover" style="left:'+e.width()/2+'px; top:0px;"><div class="slider-value-hover-label">'+tiles.AxisUtil.formatText(r,t)+"</div></div>");e.find(".slider-value-hover").finish().remove(),e.append(n),n.css({"margin-top":1.2*-n.outerHeight(),"margin-left":-n.outerWidth()/2})},this.removeLabel=function(e){e.find(".slider-value-hover").animate({opacity:0},{complete:function(){e.find(".slider-value-hover").remove()},duration:800})}})}(),function(){"use strict";var e=angular.module("crisis");e.directive("toggleClass",function(){return{restrict:"A",link:function(e,r,t){$(r).click(function(){r.toggleClass(t.toggleClass)})}}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Renderers",["RenderThemes",function(e){this.getWordCloudRenderer=function(){return new tiles.WordCloudRenderer({text:{textKey:"topic",countKey:"countMonthly",themes:e.getTextThemes()}})},this.getTextByFrequencyRenderer=function(){return new tiles.TextByFrequencyRenderer({text:{textKey:"topic",themes:e.getTextThemes()},frequency:{countKey:"countDaily",themes:e.getFrequnecyThemes()}})},this.getPointAggregateRenderer=function(){return new tiles.PointAggregateRenderer({point:{x:"x",y:"y",themes:e.getPointThemes()},aggregate:{themes:e.getAggregateThemes()}})}}])}(),function(){"use strict";var e=angular.module("crisis");e.service("RenderThemes",function(){var e=null,r=null,t=null,n=null;this.getTextThemes=function(){return e||(e=[new tiles.RenderTheme("dark",{from:{color:"#c77c11","color:hover":"#ff0000","text-shadow":"#000"},to:{color:"#f8d9ac","color:hover":"#ff0000","text-shadow":"#000"}}),new tiles.RenderTheme("light",{from:{color:"#f0d9b8","color:hover":"#ff0000","text-shadow":"#000"},to:{color:"#daa14f","color:hover":"#ff0000","text-shadow":"#000"}})]),e},this.getFrequnecyThemes=function(){return r||(r=[new tiles.RenderTheme("dark",{from:{"background-color":"#c77c11","background-color:hover":"#ff0000",border:"#000"},to:{"background-color":"#f8d9ac","background-color:hover":"#ff0000",border:"#000"}}),new tiles.RenderTheme("light",{from:{"background-color":"#f0d9b8","background-color:hover":"#ff0000",border:"#000"},to:{"background-color":"#daa14f","background-color:hover":"#ff0000",border:"#000"}})]),r},this.getPointThemes=function(){return t||(t=[new tiles.RenderTheme("dark",{"background-color":"rgba( 9, 207, 255, 0.5 )","background-color:hover":"rgba( 9, 207, 255, 0.75 )"}),new tiles.RenderTheme("light",{"background-color":"rgba( 9, 207, 255, 0.5 )","background-color:hover":"rgba( 9, 207, 255, 0.75 )"})]),t},this.getAggregateThemes=function(){return n||(n=[new tiles.RenderTheme("dark",{"background-color":"rgba(0,0,0,0)",border:"#000"}),new tiles.RenderTheme("light",{"background-color":"rgba(0,0,0,0)",border:"#000"})]),n}})}(),function(){"use strict";var e=angular.module("crisis");e.service("Views",["Pyramids","Axes","BaseLayers",function(e,r,t){function n(e,t,n){var i=[];return e.axes?_.forIn(e.axes,function(e,n){i.push(r.createAxis(n,t[e]))}):"EPSG:4326"===n.getProjection()?(i.push(r.createAxis("bottom",t.x)),i.push(r.createAxis("left",t.y))):(i.push(r.createAxis("bottom",t.longitude)),i.push(r.createAxis("left",t.latitude))),i}function i(e,r,n){var i=[];return e.baselayers?_.forIn(e.baselayers,function(e,n){var a="light"===n?1:0;i[a]=t.createBaseLayer(r[e])}):i="EPSG:4326"===n.getProjection()?[t.createBaseLayer(r["dark-plot"]),t.createBaseLayer(r["light-plot"])]:[t.createBaseLayer(r["dark-google"]),t.createBaseLayer(r["light-google"])],i}function a(e,r){var t=[];return e.layers?_.forEach(e.layers,function(e){t.push(r[e])}):_.forIn(r,function(e){t.push(e)}),t}function s(r){return e.createPyramid(e.getPyramidFromLayer(r[0]))}function o(e,r,t,o){var l=a(e,r),c=s(l),u=n(e,o,c),d=i(e,t,c);return{id:e.id,name:e.name,description:e.description,pyramid:c,layers:l,axes:u,baselayers:d}}this.getViews=function(e,r){r||(r=e,e="resources/views.json"),$.ajax({url:e,type:"GET",dataType:"json",success:function(e){r(e)},error:function(){r(null)}})},this.switchView=function(e,r){_.forIn(e.axes,function(r){e.remove(r)}),_.forIn(e.layersById,function(r){e.remove(r)});var t,n=[];_.forEach(e.baselayers,function(e){n.push(e)}),t=0===e.getBaseLayerIndex()?2:1===e.getBaseLayerIndex()?3:0,_.forEach(r.baselayers,function(r){e.add(r)}),e.setBaseLayerIndex(t),_.forEach(n,function(r){e.remove(r)}),e.setPyramid(r.pyramid),_.forEach(r.axes,function(r){e.add(r)}),_.forEach(r.layers,function(r){e.add(r)})},this.createViews=function(e,r,t,n){var i,a=[];if(e)for(i=0;i<e.length;i++)a.push(o(e[i],r,t,n));else a.push(o({},r,t,n));return a}}])}();